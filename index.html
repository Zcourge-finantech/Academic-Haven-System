<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Academic Haven | Boarding House Management</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Playfair+Display:wght@700&display=swap"
        rel="stylesheet">

    <!-- Paho MQTT -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"
        type="text/javascript"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- jsPDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <!-- SheetJS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Cropper.js -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        :root {
            --bg-app: #0f172a;
            --bg-sidebar: #020617;
            --bg-card: #1e293b;
            --primary: #6366f1;
            /* Indigo */
            --primary-hover: #4f46e5;
            --accent: #fbbf24;
            /* Amber */
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
            --border: #334155;
            --success: #10b981;
            --danger: #ef4444;
            --glass: rgba(30, 41, 59, 0.7);
            --glass-border: 1px solid rgba(255, 255, 255, 0.08);
            --radius: 16px;
            --app-zoom: 1;
        }

        * {
            box-sizing: border-box;
            outline: none;
        }

        html {
            font-size: calc(16px * var(--app-zoom));
        }

        body {
            margin: 0;
            font-family: 'Inter', sans-serif;
            background: var(--bg-app);
            color: var(--text-main);
            height: 100vh;
            overflow: hidden;
            background-image:
                radial-gradient(at 0% 0%, rgba(99, 102, 241, 0.15), transparent 50%),
                radial-gradient(at 100% 100%, rgba(251, 191, 36, 0.1), transparent 50%);
        }

        #app {
            height: 100%;
            width: 100%;
            display: block;
        }

        h1,
        h2,
        h3 {
            margin: 0;
            font-family: 'Playfair Display', serif;
        }

        .wrapper {
            display: flex;
            height: 100%;
            width: 100%;
        }

        /* Sidebar */
        .sidebar {
            width: 280px;
            background: var(--bg-sidebar);
            border-right: var(--glass-border);
            display: flex;
            flex-direction: column;
            padding: 2rem 1.5rem;
            z-index: 10;
            transition: transform 0.3s;
        }

        .nav-item {
            padding: 1rem;
            margin-bottom: 0.5rem;
            border-radius: 12px;
            color: var(--text-muted);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 1rem;
            font-weight: 600;
            transition: all 0.2s;
        }

        .nav-item:hover,
        .nav-item.active {
            background: var(--primary);
            color: white;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
            transform: translateX(5px);
        }

        /* Main Content */
        .main {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .top-bar {
            padding: 1.25rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: var(--glass-border);
            background: rgba(15, 23, 42, 0.85);
            backdrop-filter: blur(8px);
            z-index: 20;
        }

        .content {
            flex: 1;
            overflow-y: auto;
            padding: 2rem;
            position: relative;
        }

        /* Elements */
        .card {
            background: var(--glass);
            backdrop-filter: blur(12px);
            border: var(--glass-border);
            border-radius: var(--radius);
            padding: 1.5rem;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.3);
            transition: transform 0.3s ease;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.6rem;
            padding: 0.75rem 1.5rem;
            border-radius: 10px;
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-hover);
            transform: translateY(-2px);
        }

        .btn-outline {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-muted);
        }

        .btn-outline:hover {
            border-color: var(--text-main);
            color: var(--text-main);
        }

        .input,
        .select {
            width: 100%;
            padding: 0.85rem 1rem;
            background: #020617;
            border: 1px solid var(--border);
            border-radius: 10px;
            color: white;
            font-size: 0.95rem;
            margin-bottom: 1rem;
        }

        .grid {
            display: grid;
            gap: 1.5rem;
        }

        .grid-3 {
            grid-template-columns: repeat(3, 1fr);
        }

        .grid-4 {
            grid-template-columns: repeat(4, 1fr);
        }

        /* Animation */
        .animate-up {
            animation: fadeInUp 0.5s ease forwards;
            opacity: 0;
            transform: translateY(20px);
        }

        @keyframes fadeInUp {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Login */
        .login-wrap {
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: radial-gradient(circle at center, #1e293b 0%, #020617 100%);
        }

        .login-box {
            width: 100%;
            max-width: 420px;
            padding: 3rem;
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(20px);
            border-radius: 24px;
            border: 1px solid rgba(255, 255, 255, 0.05);
            text-align: center;
        }

        /* Badges */
        .badge {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
        }

        .badge-success {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
            border: 1px solid var(--success);
        }

        .badge-danger {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
            border: 1px solid var(--danger);
        }

        .badge-warning {
            background: rgba(251, 191, 36, 0.1);
            color: var(--accent);
            border: 1px solid var(--accent);
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-muted);
        }

        @media (max-width: 1024px) {
            .grid-3 {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                transform: translateX(-100%);
                left: 0;
                bottom: 0;
                top: 0;
                width: 260px;
            }

            .sidebar.active {
                transform: translateX(0);
            }

            .grid-3,
            .grid-4 {
                grid-template-columns: 1fr;
            }

            .mobile-menu-btn {
                display: flex !important;
            }

            .top-bar {
                padding: 1rem;
            }

            .content {
                padding: 1rem;
            }

            .ah-badge,
            .top-bar-sep {
                display: none;
            }
        }
    </style>
</head>

<body>
    <div id="app"></div>

    <script>
        // --- CONSTANTS ---
        const DB_KEY = 'academic_haven_v1_data';
        const MQTT_BROKER = "broker.hivemq.com";
        const MQTT_PORT = 8884;
        const MQTT_PATH = "/mqtt";
        const CLIENT_ID = "academic_haven_" + Math.random().toString(16).slice(2, 10);

        // --- DATABASE SEED ---
        const SEED = {
            users: [
                { id: 'u1', username: 'admin', password: '123', name: 'Owner', role: 'admin' },
                { id: 'u2', username: 'staff', password: '123', name: 'Staff Member', role: 'staff' }
            ],
            tenants: [],
            rooms: [
                { id: 'r1', number: '101', capacity: 2, rent: 5000, status: 'Available' },
                { id: 'r2', number: '102', capacity: 1, rent: 3500, status: 'Available' },
                { id: 'r3', number: '103', capacity: 4, rent: 8000, status: 'Available' }
            ],
            payments: [],
            expenses: [],
            settings: {
                houseName: "Academic Haven",
                currency: "PHP",
                logoUrl: "logo.png"
            }
        };

        // --- CLOUD ENGINE ---
        const Cloud = {
            client: null, channel: null, connected: false,
            connect(ch) {
                if (!ch || (this.connected && this.channel === 'academic_haven_live/' + ch)) return;
                this.channel = 'academic_haven_live/' + ch;
                this.client = new Paho.MQTT.Client(MQTT_BROKER, MQTT_PORT, MQTT_PATH, CLIENT_ID);

                this.client.onConnectionLost = (resp) => {
                    this.connected = false;
                    App.renderTopBar();
                    setTimeout(() => this.connect(ch), 5000);
                };

                this.client.onMessageArrived = (msg) => {
                    try {
                        const packet = JSON.parse(msg.payloadString);
                        if (packet.sender !== CLIENT_ID) {
                            if (db.merge(packet.data)) App.renderCurrentView();
                        }
                    } catch (e) { console.error("Cloud error", e); }
                };

                this.client.connect({
                    useSSL: true, onSuccess: () => {
                        this.connected = true;
                        this.client.subscribe(this.channel);
                        App.renderTopBar();
                    }
                });
            },
            broadcast(data) {
                if (this.connected && this.client) {
                    const msg = new Paho.MQTT.Message(JSON.stringify({ sender: CLIENT_ID, data }));
                    msg.destinationName = this.channel;
                    msg.retained = true;
                    this.client.send(msg);
                }
            }
        };

        // --- DATABASE MANAGER ---
        const db = {
            data: JSON.parse(localStorage.getItem(DB_KEY)) || SEED,
            save() {
                localStorage.setItem(DB_KEY, JSON.stringify(this.data));
                Cloud.broadcast(this.data);
            },
            merge(incoming) {
                if (JSON.stringify(this.data) === JSON.stringify(incoming)) return false;
                this.data = incoming;
                localStorage.setItem(DB_KEY, JSON.stringify(this.data));
                return true;
            },
            get(collection) { return this.data[collection]; },
            add(collection, item) {
                item.id = Date.now().toString();
                this.data[collection].push(item);
                this.save();
                return item;
            },
            update(collection, id, updates) {
                const idx = this.data[collection].findIndex(x => x.id === id);
                if (idx !== -1) {
                    this.data[collection][idx] = { ...this.data[collection][idx], ...updates };
                    this.save();
                }
            },
            delete(collection, id) {
                this.data[collection] = this.data[collection].filter(x => x.id !== id);
                this.save();
            }
        };

        // --- APP CONTROLLER ---
        const App = {
            user: null, view: 'dashboard', zoom: 1,
            init() {
                this.root = document.getElementById('app');
                this.render();
                lucide.createIcons();
            },
            login(u, p, ch) {
                const user = db.get('users').find(x => x.username === u && x.password === p);
                if (user && ch) {
                    this.user = user;
                    this.view = 'dashboard';
                    Cloud.connect(ch);
                    this.render();
                } else alert("Invalid credentials or channel.");
            },
            logout() { this.user = null; this.render(); },

            render() {
                if (!this.user) return this.renderLogin();

                this.root.innerHTML = `
                    <div class="wrapper">
                        <div class="sidebar">
                            <div style="display:flex; align-items:center; gap:1rem; margin-bottom:3rem;">
                                <div style="width:45px; height:45px; border-radius:12px; background:var(--bg-card); display:flex; align-items:center; justify-content:center; border:1px solid var(--primary); overflow:hidden;">
                                    <img id="app-logo-img" src="${db.data.settings.logoUrl}" style="width:100%; height:100%; object-fit:cover;" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex'">
                                    <div style="display:none; font-weight:800; color:var(--primary); font-size:1.2rem;">AH</div>
                                </div>
                                <div>
                                    <h3 style="font-size:1.2rem; color:white;">${db.data.settings.houseName}</h3>
                                    <p style="font-size:0.7rem; color:var(--text-muted); letter-spacing:1px; text-transform:uppercase;">Hub Manager</p>
                                </div>
                            </div>

                            <nav style="flex:1">
                                ${['dashboard', 'tenants', 'rooms', 'payments', 'expenses', 'reports'].map(v => `
                                    <div class="nav-item ${this.view === v ? 'active' : ''}" onclick="App.setView('${v}')">
                                        <i data-lucide="${this.getIcon(v)}"></i>
                                        <span style="text-transform:capitalize;">${v}</span>
                                    </div>
                                `).join('')}
                            </nav>

                            <div style="margin-top:auto; padding-top:2rem; border-top:var(--glass-border);">
                                <div style="display:flex; align-items:center; gap:1rem; margin-bottom:1.5rem;">
                                    <div style="width:40px; height:40px; border-radius:50%; background:var(--bg-card); display:flex; align-items:center; justify-content:center; border:1px solid var(--primary);">
                                        <i data-lucide="user"></i>
                                    </div>
                                    <div style="overflow:hidden">
                                        <p style="font-weight:700; font-size:0.9rem; white-space:nowrap;">${this.user.name}</p>
                                        <p style="font-size:0.7rem; color:var(--text-muted); text-transform:uppercase;">${this.user.role}</p>
                                    </div>
                                </div>
                                <div class="nav-item" onclick="App.logout()" style="color:var(--danger)">
                                    <i data-lucide="log-out"></i>
                                    <span>Logout</span>
                                </div>
                            </div>
                        </div>

                        <div class="main">
                            <div id="top-bar-el"></div>
                            <div class="content" id="content-el"></div>
                        </div>
                    </div>
                `;
                this.renderTopBar();
                this.renderCurrentView();
                lucide.createIcons();
            },

            renderLogin() {
                this.root.innerHTML = `
                    <div class="login-wrap">
                        <div class="login-box animate-up">
                            <div style="width:100px; height:100px; margin:0 auto 2rem; border-radius:24px; background:var(--bg-card); display:flex; align-items:center; justify-content:center; border:2px solid var(--primary); overflow:hidden;">
                                <img src="${db.data.settings.logoUrl}" style="width:100%; height:100%; object-fit:cover;" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex'">
                                <div style="display:none; font-weight:800; color:var(--primary); font-size:2.5rem;">AH</div>
                            </div>
                            <h1 style="font-size:2.5rem; color:white; margin-bottom:0.5rem;">${db.data.settings.houseName}</h1>
                            <p style="color:var(--text-muted); margin-bottom:2.5rem;">Boarding House Management System</p>
                            
                            <input type="text" id="login-ch" class="input" placeholder="Session Channel (e.g. MyBoardingHouse)">
                            <input type="text" id="login-u" class="input" placeholder="Username">
                            <input type="password" id="login-p" class="input" placeholder="Password">
                            
                             <button class="btn btn-primary" style="width:100%" onclick="App.login(document.getElementById('login-u').value, document.getElementById('login-p').value, document.getElementById('login-ch').value)">
                                <i data-lucide="shield-check"></i> Sign In
                            </button>
                            
                            <p style="margin-top:2rem; font-size:0.8rem; color:var(--text-muted);">Default: admin / 123</p>
                        </div>
                    </div>
                `;
                lucide.createIcons();
            },

            getIcon(v) {
                const icons = { dashboard: 'layout-dashboard', tenants: 'users', rooms: 'door-open', payments: 'wallet', expenses: 'receipt', reports: 'file-text' };
                return icons[v];
            },

            setView(v) {
                this.view = v;
                this.render();
                // Close sidebar on mobile after navigation
                if (window.innerWidth <= 768) {
                    document.querySelector('.sidebar').classList.remove('active');
                }
            },

            toggleMobileSidebar() {
                document.querySelector('.sidebar').classList.toggle('active');
            },

            renderTopBar() {
                const el = document.getElementById('top-bar-el');
                if (!el) return;
                const status = Cloud.connected ? `ðŸŸ¢ Online: ${Cloud.channel.split('/')[1]}` : 'ðŸ”´ Offline (Connecting...)';
                el.innerHTML = `
                    <div class="top-bar">
                        <div style="display:flex; align-items:center; gap:1rem;">
                            <button class="btn btn-outline mobile-menu-btn" style="padding:0.5rem; display:none" onclick="App.toggleMobileSidebar()">
                                <i data-lucide="menu"></i>
                            </button>
                            <h2 style="text-transform:capitalize; color:white;">${this.view.replace('_', ' ')}</h2>
                        </div>
                        <div style="display:flex; align-items:center; gap:1.5rem;">
                            <span class="ah-badge" style="font-size:0.85rem; color:var(--text-muted); padding:0.5rem 1rem; background:rgba(0,0,0,0.2); border-radius:30px; border:1px solid var(--border);">
                                ${status}
                            </span>
                            <div class="top-bar-sep" style="width:1px; height:24px; background:var(--border);"></div>
                            <i data-lucide="bell" style="cursor:pointer; color:var(--text-muted)"></i>
                        </div>
                    </div>
                `;
                lucide.createIcons();
            },

            renderCurrentView() {
                const el = document.getElementById('content-el');
                if (!el) return;

                switch (this.view) {
                    case 'dashboard': this.viewDashboard(el); break;
                    case 'tenants': this.viewTenants(el); break;
                    case 'rooms': this.viewRooms(el); break;
                    case 'payments': this.viewPayments(el); break;
                    case 'expenses': this.viewExpenses(el); break;
                    case 'reports': this.viewReports(el); break;
                }
            },

            // --- VIEW MODULES ---
            viewDashboard(el) {
                const tenants = db.get('tenants');
                const rooms = db.get('rooms');
                const activeTenants = tenants.filter(t => t.status === 'Active').length;
                const totalIncome = db.get('payments').reduce((s, p) => s + Number(p.amount), 0);
                const totalExpenses = db.get('expenses').reduce((s, e) => s + Number(e.amount), 0);
                const occupancy = Math.round((rooms.filter(r => r.status === 'Occupied').length / rooms.length) * 100) || 0;

                el.innerHTML = `
                    <div class="animate-up">
                        <div class="grid grid-4" style="margin-bottom:2rem;">
                            <div class="card">
                                <p style="color:var(--text-muted); font-size:0.8rem; text-transform:uppercase; font-weight:700;">Active Tenants</p>
                                <h1 style="font-size:2rem; margin:0.5rem 0;">${activeTenants}</h1>
                                <p style="color:var(--success); font-size:0.75rem;">Total registered: ${tenants.length}</p>
                            </div>
                            <div class="card">
                                <p style="color:var(--text-muted); font-size:0.8rem; text-transform:uppercase; font-weight:700;">Occupancy Rate</p>
                                <h1 style="font-size:2rem; margin:0.5rem 0;">${occupancy}%</h1>
                                <div style="height:6px; background:rgba(255,255,255,0.1); border-radius:3px; overflow:hidden">
                                    <div style="width:${occupancy}%; height:100%; background:var(--primary)"></div>
                                </div>
                            </div>
                            <div class="card">
                                <p style="color:var(--text-muted); font-size:0.8rem; text-transform:uppercase; font-weight:700;">Total Income</p>
                                <h1 style="font-size:2rem; margin:0.5rem 0;">â‚±${totalIncome.toLocaleString()}</h1>
                                <p style="color:var(--success); font-size:0.75rem;">Gross Collections</p>
                            </div>
                            <div class="card">
                                <p style="color:var(--text-muted); font-size:0.8rem; text-transform:uppercase; font-weight:700;">Net Profit</p>
                                <h1 style="font-size:2rem; margin:0.5rem 0; color:var(--accent);">â‚±${(totalIncome - totalExpenses).toLocaleString()}</h1>
                                <p style="color:var(--danger); font-size:0.75rem;">Expenses: â‚±${totalExpenses.toLocaleString()}</p>
                            </div>
                        </div>

                        <div class="grid" style="grid-template-columns: 1fr 1fr; margin-bottom:2rem;">
                            <div class="card">
                                <h3 style="margin-bottom:1.5rem;">Financial Overview</h3>
                                <canvas id="financeChart" style="height:250px"></canvas>
                            </div>
                            <div class="card">
                                <h3 style="margin-bottom:1.5rem;">Room Status</h3>
                                <div style="display:flex; justify-content:center; align-items:center; height:250px;">
                                    <canvas id="occupancyChart"></canvas>
                                </div>
                            </div>
                        </div>

                        <div class="grid" style="grid-template-columns: 2fr 1fr;">
                            <div class="card">
                                <h3 style="margin-bottom:1.5rem;">Recent Payments</h3>
                                <table style="width:100%; border-collapse:collapse;">
                                    <thead>
                                        <tr style="text-align:left; color:var(--text-muted); border-bottom:1px solid var(--border);">
                                            <th style="padding:1rem 0;">Tenant</th>
                                            <th>Amount</th>
                                            <th>Date</th>
                                            <th>Status</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${db.get('payments').slice(-5).reverse().map(p => {
                    const tenant = db.get('tenants').find(t => t.id === p.tenantId);
                    return `
                                                <tr style="border-bottom:1px solid rgba(255,255,255,0.05);">
                                                    <td style="padding:1rem 0;">${tenant?.name || 'Deleted'}</td>
                                                    <td>â‚±${Number(p.amount).toLocaleString()}</td>
                                                    <td>${new Date(p.date).toLocaleDateString()}</td>
                                                    <td><span class="badge badge-success">Paid</span></td>
                                                </tr>
                                            `;
                }).join('') || '<tr><td colspan="4" style="text-align:center; padding:2rem; color:var(--text-muted);">No payments recorded yet.</td></tr>'}
                                    </tbody>
                                </table>
                            </div>
                            <div class="card">
                                <h3 style="margin-bottom:1.5rem;">Alerts</h3>
                                <div style="display:flex; flex-direction:column; gap:1rem;">
                                    ${tenants.filter(t => t.status === 'Delinquent').map(t => `
                                        <div style="padding:1rem; background:rgba(239, 68, 68, 0.1); border-radius:12px; border:1px solid var(--danger);">
                                            <p style="font-weight:700; color:#fca5a5">Delinquent Account</p>
                                            <p style="font-size:0.9rem;">${t.name}</p>
                                            <p style="font-size:0.8rem; color:var(--text-muted);">Room ${db.get('rooms').find(r => r.id === t.roomId)?.number || 'N/A'}</p>
                                        </div>
                                    `).join('')}
                                    ${rooms.filter(r => r.status === 'Available').length > 0 ? `
                                        <div style="padding:1rem; background:rgba(16, 185, 129, 0.1); border-radius:12px; border:1px solid var(--success);">
                                            <p style="font-weight:700; color:#86efac">Rooms Available</p>
                                            <p style="font-size:0.9rem;">${rooms.filter(r => r.status === 'Available').length} vacant units</p>
                                        </div>
                                    ` : ''}
                                    ${tenants.length === 0 && rooms.length === 0 ? '<p style="color:var(--text-muted); text-align:center;">Welcome! Start by adding rooms and tenants.</p>' : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                this.renderCharts();
            },

            renderCharts() {
                setTimeout(() => {
                    const ctxFinance = document.getElementById('financeChart')?.getContext('2d');
                    if (ctxFinance) {
                        new Chart(ctxFinance, {
                            type: 'bar',
                            data: {
                                labels: ['Gross Income', 'Total Expenses', 'Net Profit'],
                                datasets: [{
                                    data: [
                                        db.get('payments').reduce((s, p) => s + Number(p.amount), 0),
                                        db.get('expenses').reduce((s, e) => s + Number(e.amount), 0),
                                        db.get('payments').reduce((s, p) => s + Number(p.amount), 0) - db.get('expenses').reduce((s, e) => s + Number(e.amount), 0)
                                    ],
                                    backgroundColor: ['#6366f1', '#ef4444', '#fbbf24']
                                }]
                            },
                            options: {
                                responsive: true,
                                plugins: { legend: { display: false } },
                                scales: { y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.05)' }, border: { display: false } } }
                            }
                        });
                    }

                    const ctxOcc = document.getElementById('occupancyChart')?.getContext('2d');
                    if (ctxOcc) {
                        const occ = db.get('rooms').filter(r => r.status === 'Occupied').length;
                        const vacant = db.get('rooms').filter(r => r.status === 'Available').length;
                        new Chart(ctxOcc, {
                            type: 'doughnut',
                            data: {
                                labels: ['Occupied', 'Vacant'],
                                datasets: [{
                                    data: [occ, vacant],
                                    backgroundColor: ['#6366f1', '#1e293b'],
                                    borderWidth: 0
                                }]
                            },
                            options: { cutout: '70%', plugins: { legend: { position: 'bottom', labels: { color: '#94a3b8' } } } }
                        });
                    }
                }, 100);
            },


            viewTenants(el) {
                el.innerHTML = `
                    <div class="animate-up">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
                            <h3 style="font-size:1.5rem;">Tenant Directory</h3>
                            <button class="btn btn-primary" onclick="App.showTenantModal()">
                                <i data-lucide="user-plus"></i> Add New Tenant
                            </button>
                        </div>
                        <div class="grid grid-3">
                            ${db.get('tenants').map(t => `
                                <div class="card tenant-card">
                                    <div style="display:flex; gap:1rem; align-items:start;">
                                        <img src="${t.idImage || 'https://ui-avatars.com/api/?name=' + t.name}" style="width:60px; height:60px; border-radius:12px; object-fit:cover;">
                                        <div style="flex:1">
                                            <h4 style="margin:0">${t.name}</h4>
                                            <p style="font-size:0.8rem; color:var(--text-muted);">${t.contact}</p>
                                            <span class="badge ${t.status === 'Active' ? 'badge-success' : 'badge-danger'}" style="margin-top:0.5rem; display:inline-block;">${t.status}</span>
                                        </div>
                                        <button class="btn-outline" style="padding:0.5rem" onclick="App.editTenant('${t.id}')">
                                            <i data-lucide="edit-3" style="width:16px"></i>
                                        </button>
                                    </div>
                                    <div style="margin-top:1.5rem; padding-top:1rem; border-top:1px solid var(--border); font-size:0.85rem;">
                                        <p style="display:flex; justify-content:space-between;"><span>Room:</span> <span>${db.get('rooms').find(r => r.id === t.roomId)?.number || 'Unassigned'}</span></p>
                                        <p style="display:flex; justify-content:space-between;"><span>Monthly:</span> <span>â‚±${db.get('rooms').find(r => r.id === t.roomId)?.rent || 0}</span></p>
                                    </div>
                                </div>
                            `).join('') || '<div class="card" style="grid-column: span 3; text-align:center; padding:4rem;">No tenants found.</div>'}
                        </div>
                    </div>
                `;
                lucide.createIcons();
            },

            viewRooms(el) {
                el.innerHTML = `
                    <div class="animate-up">
                         <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
                            <h3 style="font-size:1.5rem;">Room Assignments</h3>
                            <button class="btn btn-primary" onclick="App.showRoomModal()">
                                <i data-lucide="plus"></i> Add Room
                            </button>
                        </div>
                        <div class="grid grid-4">
                            ${db.get('rooms').map(r => {
                    const occupants = db.get('tenants').filter(t => t.roomId === r.id);
                    return `
                                    <div class="card">
                                        <div style="display:flex; justify-content:space-between; align-items:start;">
                                            <div>
                                                <h2 style="color:var(--accent)">${r.number}</h2>
                                                <p style="font-size:0.8rem; color:var(--text-muted);">Rent: â‚±${r.rent}</p>
                                            </div>
                                            <span class="badge ${r.status === 'Available' ? 'badge-success' : 'badge-warning'}">${r.status}</span>
                                        </div>
                                        <div style="margin-top:1rem; min-height:60px;">
                                            <p style="font-size:0.75rem; color:var(--text-muted); margin-bottom:0.5rem;">Occupants (${occupants.length}/${r.capacity}):</p>
                                            ${occupants.map(o => `<p style="font-size:0.85rem; font-weight:600;">â€¢ ${o.name}</p>`).join('') || '<p style="font-size:0.85rem; color:var(--border);">No occupants</p>'}
                                        </div>
                                        <button class="btn btn-outline" style="width:100%; margin-top:1rem;" onclick="App.editRoom('${r.id}')">Manage Room</button>
                                    </div>
                                `;
                }).join('')}
                        </div>
                    </div>
                `;
            },

            viewPayments(el) {
                el.innerHTML = `
                    <div class="animate-up">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
                            <h3 style="font-size:1.5rem;">Rent Collection</h3>
                            <button class="btn btn-primary" onclick="App.showPaymentModal()">
                                <i data-lucide="plus-circle"></i> Record Payment
                            </button>
                        </div>
                        <div class="card">
                            <table style="width:100%; border-collapse:collapse;">
                                <thead>
                                    <tr style="text-align:left; color:var(--text-muted); border-bottom:1px solid var(--border);">
                                        <th style="padding:1rem;">Date</th>
                                        <th style="padding:1rem;">Tenant</th>
                                        <th style="padding:1rem;">Method</th>
                                        <th style="padding:1rem;">Amount</th>
                                        <th style="padding:1rem;">Action</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${db.get('payments').slice().reverse().map(p => {
                    const t = db.get('tenants').find(te => te.id === p.tenantId);
                    return `
                                            <tr style="border-bottom:1px solid rgba(255,255,255,0.05);">
                                                <td style="padding:1rem;">${new Date(p.date).toLocaleDateString()}</td>
                                                <td style="padding:1rem; font-weight:600;">${t?.name || '---'}</td>
                                                <td style="padding:1rem;">${p.method}</td>
                                                <td style="padding:1rem; font-weight:700; color:var(--success);">â‚±${Number(p.amount).toLocaleString()}</td>
                                                <td style="padding:1rem; display:flex; gap:0.5rem;">
                                                    <button class="btn-outline" style="padding:0.4rem 0.8rem; font-size:0.75rem;" onclick="App.printReceipt('${p.id}')">Receipt</button>
                                                    <button class="btn-outline" style="padding:0.4rem; color:var(--danger); border-color:rgba(239,68,68,0.2)" onclick="App.deleteItem('payments', '${p.id}')">
                                                        <i data-lucide="trash-2" style="width:14px; height:14px;"></i>
                                                    </button>
                                                </td>
                                            </tr>
                                        `;
                }).join('') || '<tr><td colspan="5" style="text-align:center; padding:4rem; color:var(--text-muted);">No payments recorded yet.</td></tr>'}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
                lucide.createIcons();
            },

            viewExpenses(el) {
                el.innerHTML = `
                    <div class="animate-up">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
                            <h3 style="font-size:1.5rem;">Operating Expenses</h3>
                            <button class="btn btn-primary" onclick="App.showExpenseModal()">
                                <i data-lucide="plus-circle"></i> Log Expense
                            </button>
                        </div>
                        <div class="card">
                            <table style="width:100%; border-collapse:collapse;">
                                <thead>
                                    <tr style="text-align:left; color:var(--text-muted); border-bottom:1px solid var(--border);">
                                        <th style="padding:1rem;">Date</th>
                                        <th style="padding:1rem;">Category</th>
                                        <th style="padding:1rem;">Description</th>
                                        <th style="padding:1rem;">Amount</th>
                                        <th style="padding:1rem;">Action</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${db.get('expenses').slice().reverse().map(e => `
                                        <tr style="border-bottom:1px solid rgba(255,255,255,0.05);">
                                            <td style="padding:1rem;">${new Date(e.date).toLocaleDateString()}</td>
                                            <td style="padding:1rem;">
                                                <span class="badge" style="background:rgba(255,255,255,0.05)">${e.category}</span>
                                            </td>
                                            <td style="padding:1rem;">${e.description}</td>
                                            <td style="padding:1rem; font-weight:700; color:var(--danger);">â‚±${Number(e.amount).toLocaleString()}</td>
                                            <td style="padding:1rem;">
                                                <button class="btn-outline" style="padding:0.4rem; color:var(--danger); border-color:rgba(239,68,68,0.2)" onclick="App.deleteItem('expenses', '${e.id}')">
                                                    <i data-lucide="trash-2" style="width:14px; height:14px;"></i>
                                                </button>
                                            </td>
                                        </tr>
                                    `).join('') || '<tr><td colspan="4" style="text-align:center; padding:4rem; color:var(--text-muted);">No expenses recorded yet.</td></tr>'}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            },

            viewReports(el) {
                el.innerHTML = `
                    <div class="animate-up">
                         <h3 style="font-size:1.5rem; margin-bottom:2rem;">Export Center</h3>
                         <div class="grid grid-3" style="margin-bottom:2rem;">
                            <div class="card" style="text-align:center">
                                <i data-lucide="download-cloud" style="width:40px; height:40px; color:var(--primary); margin-bottom:1rem;"></i>
                                <h4>Monthly Statement</h4>
                                <p style="font-size:0.8rem; color:var(--text-muted); margin:1rem 0;">Income vs Expenses report in PDF.</p>
                                <button class="btn btn-outline" style="width:100%" onclick="App.exportPDF()">Generate PDF</button>
                            </div>
                            <div class="card" style="text-align:center">
                                <i data-lucide="table" style="width:40px; height:40px; color:var(--success); margin-bottom:1rem;"></i>
                                <h4>Tenant Ledger</h4>
                                <p style="font-size:0.8rem; color:var(--text-muted); margin:1rem 0;">Export full tenant database to Excel.</p>
                                <button class="btn btn-outline" style="width:100%" onclick="App.exportExcel('tenants')">Export XLSX</button>
                            </div>
                            <div class="card" style="text-align:center">
                                <i data-lucide="pie-chart" style="width:40px; height:40px; color:var(--accent); margin-bottom:1rem;"></i>
                                <h4>Financial History</h4>
                                <p style="font-size:0.8rem; color:var(--text-muted); margin:1rem 0;">Export all transactions to Excel.</p>
                                <button class="btn btn-outline" style="width:100%" onclick="App.exportExcel('payments')">Export XLSX</button>
                            </div>
                         </div>

                         <h3 style="font-size:1.5rem; margin-bottom:2rem;">System Maintenance</h3>
                         <div class="grid grid-3">
                            <div class="card" style="text-align:center">
                                <i data-lucide="database" style="width:40px; height:40px; color:var(--primary); margin-bottom:1rem;"></i>
                                <h4>Backup Data</h4>
                                <p style="font-size:0.8rem; color:var(--text-muted); margin:1rem 0;">Download a complete backup of your system data.</p>
                                <button class="btn btn-primary" style="width:100%" onclick="App.backupDB()">Download Backup</button>
                            </div>
                            <div class="card" style="text-align:center">
                                <i data-lucide="upload-cloud" style="width:40px; height:40px; color:var(--accent); margin-bottom:1rem;"></i>
                                <h4>Restore Data</h4>
                                <p style="font-size:0.8rem; color:var(--text-muted); margin:1rem 0;">Restore from a previous backup file.</p>
                                <label class="btn btn-outline" style="width:100%">
                                    <i data-lucide="file-up"></i> Select File
                                    <input type="file" id="restore-file" hidden accept=".json" onchange="App.restoreDB(this)">
                                </label>
                            </div>
                         </div>
                    </div>
                `;
                lucide.createIcons();
            },

            // --- MODALS & UTILS ---
            showTenantModal(id = null) {
                const t = id ? db.get('tenants').find(x => x.id === id) : null;
                const modal = this.createModal(`
                    <h3 style="margin-bottom:1.5rem;">${id ? 'Edit' : 'New'} Tenant</h3>
                    <div style="display:flex; flex-direction:column; gap:1rem;">
                        <input type="text" id="t-name" class="input" placeholder="Full Name" value="${t?.name || ''}">
                        <input type="text" id="t-contact" class="input" placeholder="Contact Number" value="${t?.contact || ''}">
                        
                        <div>
                            <p style="font-size:0.8rem; color:var(--text-muted); margin-bottom:0.5rem;">ID Image (Optional)</p>
                            <div style="display:flex; gap:1rem; align-items:center;">
                                <img id="t-id-preview" src="${t?.idImage || ''}" style="width:80px; height:80px; border-radius:12px; object-fit:cover; background:var(--bg-app); border:1px solid var(--border); display: ${t?.idImage ? 'block' : 'none'}">
                                <label class="btn btn-outline" style="flex:1">
                                    <i data-lucide="upload"></i> Upload ID
                                    <input type="file" id="t-id-file" hidden accept="image/*" onchange="App.handleIDUpload(this)">
                                </label>
                            </div>
                            <div id="cropper-wrap" style="display:none; margin-top:1rem;">
                                <div style="height:300px; background:#000; border-radius:12px; overflow:hidden;">
                                    <img id="cropper-img" style="max-width:100%">
                                </div>
                                <button class="btn btn-primary" style="width:100%; margin-top:1rem;" onclick="App.cropImage()">Crop & Save</button>
                            </div>
                        </div>

                        <select id="t-room" class="input">
                            <option value="">Select Room</option>
                            ${db.get('rooms').map(r => `<option value="${r.id}" ${t?.roomId === r.id ? 'selected' : ''}>Room ${r.number} (â‚±${r.rent}/mo)</option>`).join('')}
                        </select>
                        
                        <select id="t-status" class="input">
                            <option value="Active" ${t?.status === 'Active' ? 'selected' : ''}>Active</option>
                            <option value="Inactive" ${t?.status === 'Inactive' ? 'selected' : ''}>Inactive</option>
                            <option value="Delinquent" ${t?.status === 'Delinquent' ? 'selected' : ''}>Delinquent</option>
                        </select>

                        <div style="display:flex; gap:1rem; margin-top:1rem;">
                            <button class="btn btn-outline" style="flex:1" onclick="App.closeModal()">Cancel</button>
                            <button class="btn btn-primary" style="flex:2" onclick="App.saveTenant('${id}')">Save Tenant</button>
                        </div>
                        ${id ? `<button class="btn btn-outline" style="color:var(--danger); border-color:rgba(239, 68, 68, 0.2)" onclick="App.deleteItem('tenants', '${id}')">Delete Tenant</button>` : ''}
                    </div>
                `);
            },

            handleIDUpload(input) {
                const file = input.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = document.getElementById('cropper-img');
                    img.src = e.target.result;
                    document.getElementById('cropper-wrap').style.display = 'block';
                    if (this.cropper) this.cropper.destroy();
                    this.cropper = new Cropper(img, { aspectRatio: 1, viewMode: 1 });
                };
                reader.readAsDataURL(file);
            },

            cropImage() {
                const canvas = this.cropper.getCroppedCanvas({ width: 300, height: 300 });
                const base64 = canvas.toDataURL('image/jpeg');
                const preview = document.getElementById('t-id-preview');
                preview.src = base64;
                preview.style.display = 'block';
                document.getElementById('cropper-wrap').style.display = 'none';
                this.tempIDImage = base64;
            },

            saveTenant(id) {
                const data = {
                    name: document.getElementById('t-name').value,
                    contact: document.getElementById('t-contact').value,
                    roomId: document.getElementById('t-room').value,
                    status: document.getElementById('t-status').value,
                    idImage: this.tempIDImage || document.getElementById('t-id-preview').src
                };
                if (!data.name) return alert("Name is required");

                if (id !== 'null') db.update('tenants', id, data);
                else db.add('tenants', data);

                if (data.roomId) db.update('rooms', data.roomId, { status: 'Occupied' });

                this.tempIDImage = null;
                this.closeModal();
                this.render();
            },

            // --- ROOM MODAL ---
            showRoomModal(id = null) {
                const r = id ? db.get('rooms').find(x => x.id === id) : null;
                this.createModal(`
                    <h3 style="margin-bottom:1.5rem;">${id ? 'Edit' : 'New'} Room</h3>
                    <div style="display:flex; flex-direction:column; gap:1rem;">
                        <input type="text" id="r-num" class="input" placeholder="Room Number (e.g. 101)" value="${r?.number || ''}">
                        <input type="number" id="r-cap" class="input" placeholder="Capacity" value="${r?.capacity || ''}">
                        <input type="number" id="r-rent" class="input" placeholder="Monthly Rent (â‚±)" value="${r?.rent || ''}">
                        <select id="r-status" class="input">
                            <option value="Available" ${r?.status === 'Available' ? 'selected' : ''}>Available</option>
                            <option value="Occupied" ${r?.status === 'Occupied' ? 'selected' : ''}>Occupied</option>
                            <option value="Maintenance" ${r?.status === 'Maintenance' ? 'selected' : ''}>Maintenance</option>
                        </select>
                        <div style="display:flex; gap:1rem; margin-top:1rem;">
                            <button class="btn btn-outline" style="flex:1" onclick="App.closeModal()">Cancel</button>
                            <button class="btn btn-primary" style="flex:2" onclick="App.saveRoom('${id}')">Save Room</button>
                        </div>
                        ${id ? `<button class="btn btn-outline" style="color:var(--danger); border-color:rgba(239, 68, 68, 0.2)" onclick="App.deleteItem('rooms', '${id}')">Delete Room</button>` : ''}
                    </div>
                `);
            },

            saveRoom(id) {
                const data = {
                    number: document.getElementById('r-num').value,
                    capacity: document.getElementById('r-cap').value,
                    rent: document.getElementById('r-rent').value,
                    status: document.getElementById('r-status').value
                };
                if (!data.number) return alert("Room number is required");

                if (id !== 'null') db.update('rooms', id, data);
                else db.add('rooms', data);

                this.closeModal();
                this.render();
            },

            editRoom(id) { this.showRoomModal(id); },
            editTenant(id) { this.showTenantModal(id); },

            // --- PAYMENT REFINEMENT ---
            updateRecommendedAmount(tenantId) {
                if (!tenantId) return;
                const tenant = db.get('tenants').find(t => t.id === tenantId);
                const room = db.get('rooms').find(r => r.id === tenant?.roomId);
                if (room) {
                    document.getElementById('p-amount').value = room.rent;
                }
            },

            showPaymentModal() {
                const modal = this.createModal(`
                    <h3 style="margin-bottom:1.5rem;">Record Payment</h3>
                    <div style="display:flex; flex-direction:column; gap:1rem;">
                        <select id="p-tenant" class="input" onchange="App.updateRecommendedAmount(this.value)">
                            <option value="">Select Tenant</option>
                            ${db.get('tenants').map(t => `<option value="${t.id}">${t.name} (Room ${db.get('rooms').find(r => r.id === t.roomId)?.number || 'N/A'})</option>`).join('')}
                        </select>
                        <input type="number" id="p-amount" class="input" placeholder="Amount (â‚±)">
                        <select id="p-method" class="input">
                            <option>Cash</option>
                            <option>GCash</option>
                            <option>Bank Transfer</option>
                        </select>
                        <input type="date" id="p-date" class="input" value="${new Date().toISOString().split('T')[0]}">
                        <div style="display:flex; gap:1rem; margin-top:1rem;">
                            <button class="btn btn-outline" style="flex:1" onclick="App.closeModal()">Cancel</button>
                            <button class="btn btn-primary" style="flex:2" onclick="App.savePayment()">Record Payment</button>
                        </div>
                    </div>
                `);
            },

            savePayment() {
                const p = {
                    tenantId: document.getElementById('p-tenant').value,
                    amount: document.getElementById('p-amount').value,
                    method: document.getElementById('p-method').value,
                    date: document.getElementById('p-date').value
                };
                db.add('payments', p);
                this.closeModal();
                this.render();
            },

            printReceipt(paymentId) {
                try {
                    const p = db.get('payments').find(x => x.id === paymentId);
                    const t = db.get('tenants').find(te => te.id === p.tenantId);
                    const r = db.get('rooms').find(ro => ro.id === t?.roomId);

                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF({ format: [80, 150] });

                    const logoImg = document.getElementById('app-logo-img');
                    if (logoImg && logoImg.style.display !== 'none' && logoImg.complete && logoImg.naturalWidth > 0) {
                        try {
                            doc.addImage(logoImg, 'PNG', 30, 5, 20, 20);
                        } catch (e) { console.warn("Could not add logo to PDF", e); }
                    }

                    doc.setFont("helvetica", "bold");
                    doc.setFontSize(12);
                    doc.text(db.data.settings.houseName, 40, 30, { align: "center" });

                    doc.setFontSize(10);
                    doc.setFont("helvetica", "normal");
                    doc.text("Official Receipt", 40, 37, { align: "center" });

                    doc.line(5, 40, 75, 40);

                    doc.text(`Date: ${new Date(p.date).toLocaleDateString()}`, 10, 50);
                    doc.text(`Receipt #: ${p.id.slice(-6).toUpperCase()}`, 10, 57);

                    doc.setFont("helvetica", "bold");
                    doc.text(`Received from: ${t?.name || 'Customer'}`, 10, 67);
                    doc.setFont("helvetica", "normal");
                    doc.text(`Room: ${r?.number || 'N/A'}`, 10, 74);
                    doc.text(`Method: ${p.method || 'Cash'}`, 10, 81);

                    doc.line(5, 90, 75, 90);
                    doc.setFontSize(14);
                    doc.text(`TOTAL: PHP ${Number(p.amount).toLocaleString()}`, 40, 100, { align: "center" });
                    doc.line(5, 105, 75, 105);

                    doc.setFontSize(8);
                    doc.text("Thank you for choosing " + db.data.settings.houseName + "!", 40, 115, { align: "center" });

                    doc.save(`Receipt_${p.id.slice(-6)}.pdf`);
                } catch (err) {
                    console.error("Receipt generation failed", err);
                    alert("Error generating receipt. Please check console for details.");
                }
            },

            showExpenseModal() {
                const modal = document.createElement('div');
                modal.className = 'login-wrap';
                modal.style.position = 'fixed'; modal.style.inset = '0'; modal.style.zIndex = '1000';
                modal.innerHTML = `
                    <div class="card animate-up" style="width:90%; max-width:500px">
                        <h3>Log Expense</h3>
                        <br>
                        <select id="e-cat" class="input">
                            <option>Utility (Water/Elec)</option>
                            <option>Maintenance</option>
                            <option>Salary</option>
                            <option>Supplies</option>
                            <option>Other</option>
                        </select>
                        <input type="text" id="e-desc" class="input" placeholder="Description">
                        <input type="number" id="e-amount" class="input" placeholder="Amount (â‚±)">
                        <input type="date" id="e-date" class="input" value="${new Date().toISOString().split('T')[0]}">
                        <div style="display:flex; gap:1rem;">
                            <button class="btn btn-outline" style="flex:1" onclick="this.closest('.login-wrap').remove()">Cancel</button>
                            <button class="btn btn-primary" style="flex:1" onclick="App.saveExpense()">Log</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            },

            saveExpense() {
                const e = {
                    category: document.getElementById('e-cat').value,
                    description: document.getElementById('e-desc').value,
                    amount: document.getElementById('e-amount').value,
                    date: document.getElementById('e-date').value
                };
                db.add('expenses', e);
                document.querySelector('.login-wrap[style*="z-index: 1000"]').remove();
                this.render();
            },

            // --- MODAL ENGINE ---
            createModal(content) {
                this.closeModal();
                const wrap = document.createElement('div');
                wrap.id = 'active-modal';
                wrap.className = 'login-wrap';
                wrap.style.position = 'fixed'; wrap.style.inset = '0'; wrap.style.zIndex = '1000';
                wrap.innerHTML = `<div class="card animate-up" style="width:90%; max-width:500px; max-height:90vh; overflow-y:auto;">${content}</div>`;
                document.body.appendChild(wrap);
                lucide.createIcons();
                return wrap;
            },
            closeModal() {
                const el = document.getElementById('active-modal');
                if (el) el.remove();
            },
            deleteItem(coll, id) {
                if (confirm(`Are you sure you want to delete this ${coll.slice(0, -1)}?`)) {
                    db.delete(coll, id);
                    this.closeModal();
                    this.render();
                }
            },

            // --- EXPORTS ---
            exportPDF() {
                try {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();

                    const logoImg = document.getElementById('app-logo-img');
                    if (logoImg && logoImg.style.display !== 'none' && logoImg.complete && logoImg.naturalWidth > 0) {
                        try {
                            doc.addImage(logoImg, 'PNG', 10, 10, 20, 20);
                        } catch (e) { console.warn("Could not add logo to report", e); }
                    }

                    doc.setFontSize(22);
                    doc.text(db.data.settings.houseName, 35, 20);
                    doc.setFontSize(12);
                    doc.text("Financial Monthly Report", 35, 28);
                    doc.line(10, 35, 200, 35);

                    const data = db.get('payments').map(p => [
                        new Date(p.date).toLocaleDateString(),
                        db.get('tenants').find(t => t.id === p.tenantId)?.name || 'N/A',
                        p.method,
                        `PHP ${Number(p.amount).toLocaleString()}`
                    ]);

                    doc.autoTable({
                        startY: 45,
                        head: [['Date', 'Tenant', 'Method', 'Amount']],
                        body: data,
                        theme: 'striped',
                        headStyles: { fillColor: [99, 102, 241] }
                    });

                    doc.save("Report_" + Date.now() + ".pdf");
                } catch (err) {
                    console.error("Report generation failed", err);
                    alert("Error generating report. Please check console for details.");
                }
            },

            exportExcel(type) {
                const data = db.get(type);
                const ws = XLSX.utils.json_to_sheet(data);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Data");
                XLSX.writeFile(wb, type + "_" + Date.now() + ".xlsx");
            },

            backupDB() {
                const data = JSON.stringify(db.data, null, 2);
                const blob = new Blob([data], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `AcademicHaven_Backup_${new Date().toISOString().split('T')[0]}.json`;
                a.click();
            },

            restoreDB(input) {
                const file = input.files[0];
                if (!file) return;
                if (!confirm("Warning: This will overwrite ALL current data. Proceed?")) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        if (data.users && data.tenants) {
                            db.data = data;
                            db.save();
                            alert("Data restored successfully!");
                            location.reload();
                        } else alert("Invalid backup file.");
                    } catch (err) { alert("Error parsing backup file."); }
                };
                reader.readAsText(file);
            }
        };

        // Start App
        window.onload = () => App.init();
    </script>
</body>

</html>
```